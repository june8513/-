<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>物料</th>
                <th>品名</th>
                <th>儲格</th>
                <th>庫存</th>
                <th>需求數量</th>
                <th>投料點</th>
                <th>已撥料數量</th>
                {% if show_change_input %}
                <th style="width: 15%;">本次變動</th>
                {% endif %}
                <th>簽收狀態</th>
                {% if show_actions %}
                <th>操作</th>
                {% endif %}
            </tr>
        </thead>
        <tbody id="materials-tbody">
            {% for material in materials %}
                <tr data-process-type="{{ material.process_type.id }}" class="{% if not material.is_active %}table-secondary{% endif %}">
                    <td>
                        {{ material.material_number }}
                        {% if not material.is_active %}
                            <span class="badge bg-danger ms-1">已歸檔</span>
                        {% endif %}
                    </td>
                    <td class="text-truncate-cell">{{ material.item_name }}</td>
                    <td>{{ material.storage_bin|default:"N/A" }}</td>
                    <td>{{ material.stock_quantity|default:"0"|floatformat:2 }}</td>
                    <td>{{ material.required_quantity|floatformat:2 }}</td>
                    <td>{{ material.process_type.name|default:"N/A" }}</td>
                    <td>{{ material.confirmed_quantity|default:"0"|floatformat:2 }}</td>
                    {% if show_change_input %}
                    <td>
                        <input type="number" step="0.01" name="change_{{ material.pk }}" class="form-control form-control-sm" {% if not material.is_active %}disabled{% endif %}>
                    </td>
                    {% endif %}
                    <td class="dispatch-status-{{ material.pk }}">
                        {% if material.confirmed_quantity == material.required_quantity and material.is_signed_off %}
                            <span class="badge bg-success">已撥料</span>
                        {% elif material.confirmed_quantity == 0 and not material.is_signed_off %}
                            <span class="badge bg-secondary">未撥料</span>
                        {% elif material.confirmed_quantity > 0 and material.confirmed_quantity < material.required_quantity %}
                            <span class="badge bg-warning">部分撥料</span>
                        {% else %} {# This is the case where buttons should appear #}
                            <span class="badge bg-info">未簽收</span>
                        {% endif %}
                    </td>
                    {% if show_actions %}
                    <td>
                        {% if material.confirmed_quantity == material.required_quantity and material.is_signed_off %}
                            {# Already handled as 'yes', no buttons #}
                        {% elif material.confirmed_quantity == 0 and not material.is_signed_off %}
                            {# Already handled as 'no', no buttons #}
                        {% else %} {# Show buttons for unhandled or partially handled #}
                            <button type="button" class="btn btn-sm btn-success dispatch-action-btn" data-material-id="{{ material.pk }}" data-action="yes">是</button>
                            <button type="button" class="btn btn-sm btn-danger dispatch-action-btn" data-material-id="{{ material.pk }}" data-action="no">否</button>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
            {% empty %}
                <tr>
                    <td colspan="{% if show_change_input %}9{% else %}8{% endif %}" class="text-center">找不到物料。</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>