{% extends 'base.html' %}

{% load widget_tweaks %}

{% block title %}簽收撥料申請單 - {{ requisition.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">簽收撥料申請單 - {{ requisition.order_number }}</h2>

    <div class="card mb-4">
        <div class="card-header">
            申請單資訊
        </div>
        <div class="card-body">
            <p><strong>訂單單號:</strong> {{ requisition.order_number }}</p>
            <p><strong>申請人:</strong> {{ requisition.applicant.username }}</p>
            <p><strong>需求日期:</strong> {{ requisition.request_date|date:"Y-m-d" }}</p>
            <p><strong>狀態:</strong> <span class="badge bg-{% if requisition.status == 'pending' %}warning{% elif requisition.status == 'materials_confirmed' %}info{% elif requisition.status == 'completed' %}success{% else %}secondary{% endif %}">{{ requisition.get_status_display }}</span></p>
        </div>
    </div>

    {% if requisition.images.all %}
        <div class="mb-3">
            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewRequisitionImagesModal">
                查看已上傳圖片 ({{ requisition.images.count }} 張)
            </button>
        </div>
    {% endif %}

    <h3 class="mt-4">物料清單 (版本: {{ target_version.uploaded_at|date:"Y-m-d H:i" }})</h3>
    {% if target_version and target_version.items.all %}
        {% include 'requisitions/_material_table.html' with materials=target_version.items.all show_change_input=False show_actions=True requisition=requisition target_version=target_version %}
    {% else %}
        <p class="mt-4">此申請單沒有當前物料清單。</p>
    {% endif %}

    {% if requisition.status == 'completed' %}
        <p class="mt-4 alert alert-success">此申請單已於 {{ requisition.sign_off_date|date:"Y-m-d H:i" }} 由 {{ requisition.sign_off_by.username }} 最終簽收。</p>
    {% elif requisition.status == 'materials_confirmed' %}
        <p class="mt-4 alert alert-info">此申請單已於 {{ requisition.material_confirmed_date|date:"Y-m-d H:i" }} 由 {{ requisition.material_confirmed_by.username }} 完成物料確認。</p>
    {% endif %}

    <div id="sign-off-message-container" class="mt-3"></div>

<!-- View Requisition Images Modal -->
<div class="modal fade" id="viewRequisitionImagesModal" tabindex="-1" aria-labelledby="viewRequisitionImagesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRequisitionImagesModalLabel">已上傳圖片</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="requisition-images-gallery" class="row">
                    <!-- Images will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const signOffButtons = document.querySelectorAll('.sign-off-btn');
        const messageContainer = document.getElementById('sign-off-message-container');

        function showMessage(message, type = 'danger') {
            messageContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        }

        signOffButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('Button clicked!');
                const url = this.dataset.url;
                console.log('AJAX URL:', url);
                const button = this;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    console.log('Response received:', response);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data received:', data);
                    if (data.success) {
                        button.innerText = '已簽收';
                        button.classList.remove('btn-success');
                        button.classList.add('badge', 'bg-success');
                        button.disabled = true;
                        showMessage(data.message, 'success');
                    } else {
                        showMessage('簽收失敗: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('發生錯誤，請重試。' + error, 'danger');
                });
            });
        });

        // JavaScript for View Requisition Images Modal
        const viewRequisitionImagesModal = document.getElementById('viewRequisitionImagesModal');
        if (viewRequisitionImagesModal) {
            viewRequisitionImagesModal.addEventListener('show.bs.modal', function (event) {
                const galleryDiv = viewRequisitionImagesModal.querySelector('#requisition-images-gallery');
                const requisitionPk = "{{ requisition.pk }}";
                galleryDiv.innerHTML = '<p>載入圖片中...</p>'; // Loading message

                fetch(`/requisitions/${requisitionPk}/images_json/`) // Assuming a new URL for images JSON
                    .then(response => response.json())
                    .then(data => {
                        galleryDiv.innerHTML = ''; // Clear loading message
                        if (data.images && data.images.length > 0) {
                            data.images.forEach(image => {
                                const colDiv = document.createElement('div');
                                colDiv.className = 'col-md-4 mb-3'; // Bootstrap grid for 3 images per row
                                colDiv.innerHTML = `
                                    <a href="${image.url}" target="_blank">
                                        <img src="${image.url}" class="img-fluid img-thumbnail" alt="Requisition Image">
                                    </a>
                                `;
                                galleryDiv.appendChild(colDiv);
                            });
                        } else {
                            galleryDiv.innerHTML = '<p>沒有圖片可顯示。</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading images:', error);
                        galleryDiv.innerHTML = '<p class="text-danger">無法載入圖片。</p>';
                    });
            });
        }
    });
</script>
{% endblock %}