{% extends 'requisitions/base.html' %}
{% load inventory_extras %}

{% block title %}盤點 - {{ location_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">盤點作業 - {{ location_name }}</h1>
            <a href="{% url 'stocktake_location_list' %}" class="btn btn-secondary btn-sm">返回地點選擇</a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th>{% sortable_header 'bin' '儲格' %}</th>
                            <th>{% sortable_header 'material_code' '物料' %}</th>
                            <th>{% sortable_header 'material_description' '物料說明' %}</th>
                            <th>{% sortable_header 'system_quantity' '系統庫存' %}</th>
                            <th style="width: 15%;">{% sortable_header 'latest_counted_quantity' '實際盤點數量' %}</th>
                            <th>{% sortable_header 'last_counted_by__username' '盤點人員' %}</th>
                            <th>{% sortable_header 'last_counted_date' '盤點時間' %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr id="row-{{ material.id }}">
                            <td>{{ material.bin }}</td>
                            <td>{{ material.material_code }}</td>
                            <td>{{ material.material_description }}</td>
                            <td>{{ material.system_quantity }}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm counted-quantity-input" data-id="{{ material.id }}" value="{{ material.latest_counted_quantity|default_if_none:'' }}">
                            </td>
                            <td id="counted-by-{{ material.id }}">{{ material.last_counted_by.username|default:"" }}</td>
                            <td id="counted-date-{{ material.id }}">{{ material.last_counted_date|date:"Y-m-d H:i"|default:"" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">此地點沒有物料。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrfToken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.counted-quantity-input');
    
    console.log(`Found ${inputs.length} quantity inputs.`); // Debugging

    inputs.forEach(input => {
        input.addEventListener('change', function(event) {
            const materialId = event.target.dataset.id;
            const quantity = event.target.value;
            const row = document.getElementById('row-' + materialId);

            console.log(`Change detected for material ID: ${materialId}, new quantity: ${quantity}`); // Debugging

            // Show saving indicator
            const originalColor = row.style.backgroundColor;
            row.style.backgroundColor = '#fff3cd'; // Bootstrap 'warning' yellow

            fetch(`{% url 'update_counted_quantity' %}`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    'material_id': materialId,
                    'quantity': quantity
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Save successful:', data); // Debugging
                if (data.status === 'success') {
                    row.style.backgroundColor = '#d1e7dd'; // Bootstrap 'success' green
                    // Update the user and date fields
                    document.getElementById('counted-by-' + materialId).textContent = data.last_counted_by;
                    
                    const date = new Date(data.last_counted_date);
                    const formattedDate = date.getFullYear() + '-' +
                                      ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
                                      ('0' + date.getDate()).slice(-2) + ' ' +
                                      ('0' + date.getHours()).slice(-2) + ':' +
                                      ('0' + date.getMinutes()).slice(-2);
                    document.getElementById('counted-date-' + materialId).textContent = formattedDate;

                    setTimeout(() => {
                        row.style.backgroundColor = originalColor;
                    }, 2000);
                } else {
                    row.style.backgroundColor = '#f8d7da'; // Bootstrap 'danger' red
                    alert('儲存失敗: ' + data.message);
                }
            })
            .catch(error => {
                row.style.backgroundColor = '#f8d7da';
                console.error('Error:', error);
                alert('發生網路或伺服器錯誤，請稍後再試。');
            });
        });
    });
});
</script>
{% endblock %}